# 🎯 自動実行機能ガイド

## ✨ 追加された機能

### 1. 前日の配信を自動検出
- 毎日、前日（00:00-23:59）の配信を自動的に検出
- 配信が複数ある場合は全て処理
- 配信がない日はスキップ

### 2. 自動実行のON/OFF切替
- Webダッシュボードから簡単に切り替え可能
- 設定はファイルに保存され、再起動後も維持
- リアルタイムでステータス表示

### 3. Cron Jobによる定期実行
- 毎日午前2時に自動実行（日本時間11時）
- Renderのスケジューラーで確実に実行
- ログで実行結果を確認可能

## 🖥️ Webダッシュボードでの操作

### URL
デプロイ完了後、以下のURLにアクセス：
```
https://create-cut-out-videos.onrender.com
```

### 自動実行設定セクション

#### ① 有効化ボタン（緑色）
```
✓ 自動実行を有効にする
```
- クリックすると、毎日自動的に前日の配信を処理
- Cron Jobが有効になる

#### ② 無効化ボタン（オレンジ色）
```
✗ 自動実行を無効にする
```
- クリックすると、自動実行を停止
- 手動実行は引き続き可能

#### ③ ステータス表示
```
現在のステータス: ✓ 有効 または ✗ 無効
```
- 現在の自動実行状態をリアルタイム表示
- 5秒ごとに自動更新

#### ④ 手動実行ボタン
```
📅 前日の配信を今すぐ処理
```
- 自動実行を待たずに、今すぐ前日の配信を処理
- テスト用や、処理漏れの補完に便利

## 🔧 動作仕様

### 前日の配信の定義
```
前日 = 実行日の1日前の00:00～23:59
```

**例**:
- 実行日: 2026年1月19日
- 対象: 2026年1月18日 00:00:00 ～ 23:59:59 の配信

### 処理フロー
```
1. 前日の日付範囲を計算
   ↓
2. 対象チャンネルの配信を検索（YouTube API）
   ↓
3. 前日の配信のみフィルタ
   ↓
4. 配信が0本 → スキップ
   配信が1本以上 → 全て処理
   ↓
5. 各配信ごとに切り抜き動画を生成
   ↓
6. 結果をログに記録
```

### 複数配信の処理
- 前日に2回以上配信があった場合、全て処理
- 各配信は個別に切り抜き動画として出力
- 処理は順次実行（並列処理なし）

## ⏰ Cron Job設定

### スケジュール
```
0 2 * * *  # 毎日午前2時（UTC）
```

**日本時間（JST）**:
- UTC 2:00 = JST 11:00（午前11時）

### スケジュールの変更

週1回にする場合:
```yaml
schedule: "0 2 * * 0"  # 毎週日曜日午前2時
```

週2回にする場合:
```yaml
schedule: "0 2 * * 0,3"  # 日曜と水曜の午前2時
```

## 🛠️ コマンドライン操作

### 自動実行の有効化
```bash
python auto_scheduler.py enable
```

### 自動実行の無効化
```bash
python auto_scheduler.py disable
```

### ステータス確認
```bash
python auto_scheduler.py status
```

### 前日の配信を今すぐ処理
```bash
python auto_scheduler.py
```

## 📁 設定ファイル

### 保存場所
```
./config/auto_run.txt
```

### 内容
```
true  # 有効
false # 無効
```

### 優先順位
1. **`config/auto_run.txt`** (最優先)
2. 環境変数 `AUTO_RUN_ENABLED`
3. デフォルト: `true`

## 🔍 ログ確認

### スケジューラーログ
```
./logs/scheduler.log
```

### 内容例
```
2026-01-19 02:00:05 - auto_scheduler - INFO - === 前日配信の自動処理を開始 ===
2026-01-19 02:00:06 - auto_scheduler - INFO - 前日の配信を検索: 2026-01-18
2026-01-19 02:00:08 - auto_scheduler - INFO -   ✓ 【配信タイトル】 (2026-01-18 20:00:00)
2026-01-19 02:00:08 - auto_scheduler - INFO - 前日の配信: 1本
2026-01-19 02:15:30 - auto_scheduler - INFO - ✓ 処理成功: ./output/xxxxx_highlight.mp4
2026-01-19 02:15:30 - auto_scheduler - INFO - === 処理完了 ===
2026-01-19 02:15:30 - auto_scheduler - INFO - 成功: 1本
```

## ⚙️ Renderでの設定

### 環境変数

Renderダッシュボードで以下を設定:

| Key | Value | 説明 |
|-----|-------|------|
| `AUTO_RUN_ENABLED` | `true` | 自動実行の有効/無効 |

### Cron Job作成手順

1. Renderダッシュボードで **"New +"** → **"Cron Job"**
2. リポジトリ選択: **Create-cut-out-videos**
3. 設定:
   - **Name**: `youtube-clipper-cron`
   - **Environment**: **Docker**
   - **Dockerfile Path**: `./Dockerfile`
   - **Docker Command**: `python auto_scheduler.py`
   - **Schedule**: `0 2 * * *`
4. 環境変数を設定（Webサービスと同じ）
5. **"Create Cron Job"** をクリック

## 💡 使用例

### パターン1: 毎日自動処理
```
1. Webダッシュボードで「自動実行を有効にする」をクリック
2. そのまま放置
3. 毎日午前2時（UTC）に自動処理
4. 結果はログとWebダッシュボードで確認
```

### パターン2: 週1回自動処理
```
1. render.yamlでscheduleを変更:
   schedule: "0 2 * * 0"  # 毎週日曜日
2. GitHubにプッシュ
3. Renderが自動的に再デプロイ
```

### パターン3: 手動処理のみ
```
1. Webダッシュボードで「自動実行を無効にする」をクリック
2. 必要な時だけ「前日の配信を今すぐ処理」をクリック
```

## 🎯 シナリオ別の動作

### シナリオ1: 前日に配信が1本
```
✓ 1本の切り抜き動画を生成
✓ output/に保存
✓ ログに記録
```

### シナリオ2: 前日に配信が2本以上
```
✓ 全ての配信を処理
✓ 各配信ごとに切り抜き動画を生成
✓ 例: 配信が3本 → 切り抜き動画も3本
```

### シナリオ3: 前日に配信がない
```
✓ 処理をスキップ
✓ ログに「前日配信なし」と記録
✓ エラーにはならない
```

### シナリオ4: 自動実行が無効
```
✓ Cron Jobが実行されても処理をスキップ
✓ ログに「自動実行が無効」と記録
✓ 手動実行は可能
```

## ⚠️ 注意事項

### 1. タイムゾーン
- Renderの時刻はUTC
- 日本時間（JST）= UTC + 9時間
- スケジュール調整時は注意

### 2. 処理時間
- 1本の配信の処理に20-40分かかる
- 複数配信がある場合、全体で数時間かかることも
- Renderのタイムアウトに注意

### 3. コスト
- Cron Jobの実行時間に応じて課金
- 毎日実行: 約$7-20/月
- 週1回実行: 約$5-10/月

### 4. ストレージ
- 生成された動画は`output/`に保存
- 定期的に古い動画を削除推奨
- Renderの容量制限に注意

## 📞 トラブルシューティング

### 問題: 自動実行されない

**確認事項**:
1. Cron Jobが作成されているか（Renderダッシュボード）
2. 自動実行が有効か（Webダッシュボード）
3. `AUTO_RUN_ENABLED=true`が設定されているか
4. ログを確認（Renderのログタブ）

### 問題: 前日の配信が検出されない

**原因**:
- YouTube APIの遅延
- 配信が「完了」状態になっていない
- チャンネルIDが間違っている

**解決策**:
- 数時間後に再実行
- 手動で「前日の配信を今すぐ処理」を実行

### 問題: ON/OFFが切り替わらない

**確認事項**:
1. `config`ディレクトリが存在するか
2. 書き込み権限があるか
3. ブラウザのキャッシュをクリア

## 🎉 まとめ

自動実行機能により、以下が実現できます：

- ✅ 毎日の手動作業が不要
- ✅ 配信翌日に自動的に切り抜き動画が完成
- ✅ Webダッシュボードで簡単にON/OFF
- ✅ 配信がない日は自動スキップ
- ✅ 複数配信も全て自動処理

---

**更新日**: 2026-01-18  
**GitHubリポジトリ**: https://github.com/kyo10310415/Create-cut-out-videos  
**デプロイURL**: https://create-cut-out-videos.onrender.com
